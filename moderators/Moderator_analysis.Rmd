---
title: "Generalized Linear Mixed Models for Moderator Analyses"
date: "2025-10-07"
output:
  html_document:
    toc: true
    toc_float: true
    theme: flatly
    toc_depth: 4
    number_sections: true
    code_folding: hide
  word_document:
    toc: true
    toc_depth: 4
  pdf_document:
    toc: true
    toc_depth: 4
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = TRUE, message = FALSE, cache = FALSE)

# Set the root directory for the entire document (recommended way)
knitr::opts_knit$set(root.dir = dirname(rstudioapi::getActiveDocumentContext()$path))
```

# Preparation

```{r load-packages}
library(tidyverse)
library(lme4)
library(broom.mixed)
library(forcats)
library(gt)
library(knitr)
library(dplyr)
library(purrr)
library(stringr)
library(tidyr)
```

## Load Data

```{r load-data}
# load data
df_moderation <- read.csv2("../pre-processing/output/data_for_moderation_analyses.csv", dec = ".")

# calculate Sample_Size_100
df_moderation <- df_moderation %>%
  mutate(Sample_Size_100 = Sample_Size / 100)

# Display the first rows to check the data
head(df_moderation)
```

## Descriptive Statistics

We provide basic descriptive statistics of the included studies, without excluding any data due to missingness.

```{r descriptives}
# Calculate descriptives
total_number_of_samples <- nrow(df_moderation)
total_sample_size <- sum(df_moderation$Sample_Size, na.rm = TRUE)

# Create a summary table
summary_table <- data.frame(
  Description = c("Number of samples / cohorts", "Total sample size (sum of available Sample_Size)"),
  Value = format(c(total_number_of_samples, total_sample_size), big.mark = ",")
)

# Display as a table
knitr::kable(summary_table, caption = "Descriptive Statistics of the Dataset")
```

# Moderator Analyses

Here we fit binomial GLMMs (random intercept for `Study`) separately for the continuous and categorical moderators. For continuous moderators, we report the estimated prevalence at the reference (moderator = 0) and the marginal delta (approximate change in percentage points per 1‑unit increase). For categorical moderators, we report the estimated prevalence for the reference level and contrasted level(s).

## Moderators setup
```{r mods-setup-functions}
# distinguish between continuous and categorical variables
cont_vars <- c(
  "Percentage_women",
  "Mean_age",
  "Percentage_minority",
  "Percentage_partner",
  "High_education",
  "TP_assessments",
  "N_trajectories",
  "Trauma_TP1",
  "TP1_TPX",
  "Trauma_TPX",
  "Entropy",
  "Grolts",
  "Sample_Size_100" # unit = 100 participants
)

cat_vars <- list(
  list(var="Diagnostic_DSM",     keep=c("4","5"),                 ref="4"),
  list(var="Occupational_trauma",keep=c("No","Yes"),              ref="No"),
  list(var="Developmental_age",  keep=c("Adult","Youth"),         ref="Adult"),
  list(var="Location",           keep=NULL,                       ref=NULL),
  list(var="Location_US",        keep=NULL,                       ref="Non-US"),
  list(var="Trajectory_analysis",keep=NULL,                       ref=NULL),
  list(var="Scale_moderator",    keep=c("Interview","Self"),      ref="Interview"),
  list(var="Trauma_exposure",    keep=c("Inter","Non"),           ref="Inter"),
  list(var="Trauma_type",        keep=c("Combat","Natural","Injury"), ref="Combat"),
  list(var="Military",           keep=NULL,                       ref="No"),
  list(var="Discrete",           keep=c("No","Yes"),              ref="No"),
  list(var="Health_First",       keep=c("Yes","No"),              ref="Yes")
)

# Consistent optimizer for all fits
ctrl <- glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 2e5))

# Utility to add Success/Failure columns for a given trajectory
add_binom_cols <- function(data, success_col = "Low_n", denom_col = "Sample_Size") {
  stopifnot(success_col %in% names(data), denom_col %in% names(data))
  data %>%
    mutate(
      Success = .data[[success_col]],
      Failure = .data[[denom_col]] - Success
    )
}

#fit model for one predictor and return the key stats
fit_cont <- function(data, var, success_col = "Low_n", denom_col = "Sample_Size") {
  d <- data %>%
    filter(!is.na(.data[[var]])) %>%
    add_binom_cols(success_col = success_col, denom_col = denom_col)

  fml <- as.formula(paste0("cbind(Success, Failure) ~ ", var, " + (1 | Study)"))
  m <- glmer(fml, data = d, family = binomial, control = ctrl)

  coefs <- summary(m)$coefficients
  b0 <- unname(fixef(m)["(Intercept)"])
  b1 <- unname(fixef(m)[var])
  p0 <- plogis(b0)

  p_col <- intersect(colnames(coefs), c("Pr(>|z|)", "Pr(>|t|)", "Pr(>|Chisq|)"))
  pval  <- if (length(p_col)) unname(coefs[var, p_col[1]]) else NA_real_

  tibble(
    trajectory = sub("_n$", "", success_col),
    predictor  = var,
    Samples    = nobs(m),
    prevalence_at_0_pct        = 100 * p0,
    slope                      = b1,
    marginal_delta_pp_per_unit = b1 * p0 * (1 - p0) * 100,
    p_value                    = pval
  )
}

# Fit one categorical moderator and return prevalence by level + Δ vs ref (pp) + p-values
fit_cat <- function(data, var, keep = NULL, ref = NULL,
                    success_col = "Low_n", denom_col = "Sample_Size") {
  stopifnot(var %in% names(data))

  d <- data %>%
    filter(!is.na(.data[[var]])) %>%
    { if (!is.null(keep)) filter(., .data[[var]] %in% keep) else . } %>%
    mutate(
      !!var := factor(.data[[var]]),
      !!var := if (!is.null(ref) && ref %in% levels(.data[[var]]))
                 fct_relevel(.data[[var]], ref)
               else fct_drop(.data[[var]])
    ) %>%
    add_binom_cols(success_col = success_col, denom_col = denom_col)

  if (nlevels(d[[var]]) < 2) return(tibble())  # nothing to compare

  fml <- as.formula(paste0("cbind(Success, Failure) ~ ", var, " + (1 | Study)"))
  m <- glmer(fml, data = d, family = binomial, control = ctrl)

  fe <- fixef(m)
  b0 <- unname(fe["(Intercept)"])
  lvls <- levels(d[[var]])

  # baseline = first level
  add <- sapply(lvls, function(L) {
    nm <- paste0(var, L)                 # e.g., "Trauma_typeNatural"
    if (nm %in% names(fe)) fe[[nm]] else 0
  })

  s <- summary(m)$coefficients
  pcol <- intersect(colnames(s), c("Pr(>|z|)", "Pr(>|t|)", "Pr(>|Chisq|)"))
  pvals <- sapply(lvls, function(L) {
    nm <- paste0(var, L)
    if (nm %in% rownames(s)) unname(s[nm, pcol[1]]) else NA_real_  # ref has NA
  })

  p <- plogis(b0 + add)
  p_ref <- p[1]

  tibble(
    trajectory      = sub("_n$", "", success_col),
    moderator       = var,
    n               = nobs(m),               # Samples (k)
    ref_level       = lvls[1],
    level           = lvls,
    prevalence_pct  = 100 * p,
    diff_vs_ref_pp  = 100 * (p - p_ref),
    p_value         = pvals
  )
}
```

## Tables Setup

```{r mods-setup-tables}
# helpers for p formatting
fmt_p <- function(p) ifelse(is.na(p), "", ifelse(p < .001, "< .001", sprintf("%.3f", p)))
sig   <- function(p) dplyr::case_when(is.na(p) ~ "", p < .001 ~ "***", p < .01 ~ "**", p < .05 ~ "*", TRUE ~ "")

# Moderator labels for tables
mod_labels <- c(
  Percentage_women    = "Percentage of women",
  Mean_age            = "Mean age",
  Percentage_minority = "Minorities (%)",
  Percentage_partner  = "Having a partner (%)",
  High_education      = "Education (%)",
  TP_assessments      = "Time point PTSD assessments",
  N_trajectories      = "Number of trajectories",
  Trauma_TP1          = "Time between trauma and first assessment (months)",
  TP1_TPX             = "Time span of the study (months)",
  Trauma_TPX          = "Time between trauma and last assessment (months)",
  Entropy             = "Entropy",
  Grolts              = "Quality score",
  Sample_Size_100     = "Sample size / 100",
  Diagnostic_DSM      = "Diagnostic Criteria",
  Occupational_trauma = "Occupational trauma",
  Developmental_age   = "Developmental age",
  Location            = "Country income",
  Location_US         = "US vs Non-US",
  Trajectory_analysis = "LGMM vs LCGA",
  Scale_moderator     = "PTSD symptom assessment",
  Trauma_exposure     = "Trauma exposure",
  Trauma_type         = "Trauma nature",
  Military            = "Civilian vs Military",
  Discrete            = "Discrete vs non-discrete trauma",
  Health_First        = "HP/First responders vs other"
)

# continuous variable labels for tables
mod_levels <- unname(mod_labels)
delta_col  <- "Marginal Δ"  # use literal Δ; save file as UTF-8

# categorical moderator level labels for tables
level_labels <- list(
  Diagnostic_DSM      = c(`4` = "DSM-IV", `5` = "DSM-5"),
  Occupational_trauma = c(No = "No", Yes = "Yes"),
  Developmental_age   = c(Adult = "Adult", Youth = "Youth"),
  Location            = c(
    "High income countries" = "High income countries",
    "High-income countries" = "High income countries",
    "High"                  = "High income countries",
    "HIC"                   = "High income countries",
    "Mid-, low- income"     = "Mid-, low- income",
    "Mid/low income"        = "Mid-, low- income",
    "LMIC"                  = "Mid-, low- income"
  ),
  Location_US         = c(`Non-US` = "Non-US", US = "US"),

  Trajectory_analysis = c(LCGA = "LCGA", LGMM = "LGMM"),
  Scale_moderator     = c(Interview = "Interview", Self = "Self-reported scale"),
  Trauma_exposure     = c(Inter = "Interpersonal trauma", Non = "Non-interpersonal trauma"),
  Trauma_type         = c(Combat = "Combat", Injury = "Injury", Natural = "Natural disaster"),
  Military            = c(No = "Civilian", Yes = "Military"),
  Discrete            = c(No = "Non-discrete", Yes = "Discrete"),
  Health_First        = c(Yes = "HP/First responder", No = "Other")
)

# Build a lookup tibble we can join onto both ref and comparison
lvl_map <- purrr::imap_dfr(level_labels, ~tibble::tibble(
  moderator = .y,
  orig      = names(.x),
  pretty    = unname(.x)
))
```

## 🚀 Low Symptom Trajectory

```{r low-moderators-setup}

df_Low <- df_moderation %>%
  filter(!is.na(Low_percentage))

# Calculate Low_n as (percentage / 100) * sample size
df_Low$Low_n <-
  round((df_Low$Low_percentage / 100) * df_Low$Sample_Size)
```

### Descriptives

We provide additional descriptives based on the Low trajectory variable, using the full dataset.

```{r Low-descriptives}

# Total number of individuals classified as Low (ignoring missingness in other variables)
total_Low_n <- sum(df_Low$Low_n, na.rm = TRUE)

# Number of unique samples
unique_samples <- length(unique(df_Low$Study))

# Display as a table
additional_info <- data.frame(
  Description = c("Total number of individuals in Low trajectory", "Number of unique samples"),
  Value = format(c(total_Low_n, unique_samples), big.mark = ",")
)

knitr::kable(additional_info, caption = "Additional Descriptives for Low Trajectory Analysis")
```

### Continuous moderators

```{r Low-mods-cont}
fit_cont_Low <- \(data, var) fit_cont(data, var, success_col = "Low_n", denom_col = "Sample_Size")

fits_cont_Low <- map_dfr(cont_vars, ~fit_cont_Low(df_Low, .x)) %>%
  mutate(across(where(is.numeric), ~round(.x, 3)))

# table rendering
tbl <- fits_cont_Low %>%
  mutate(
    Predictor = dplyr::recode(predictor, !!!mod_labels, .default = predictor),
    Predictor = factor(Predictor, levels = mod_levels),
    `Prevalence (0%)` = sprintf("%.1f%%", prevalence_at_0_pct),
    !!delta_col := marginal_delta_pp_per_unit,
    `P-value` = paste0(fmt_p(p_value), ifelse(is.na(p_value), "", paste0(" ", sig(p_value)))),
    Slope = slope
  ) %>%
  select(Predictor, Samples, `Prevalence (0%)`, Slope, dplyr::all_of(delta_col),`P-value`) %>%
  arrange(Predictor)

# ensure the table and its column names are UTF-8
tbl_utf8 <- tbl
names(tbl_utf8) <- enc2utf8(names(tbl_utf8))
tbl_utf8 <- dplyr::mutate(tbl_utf8, dplyr::across(where(is.character), enc2utf8))

tbl_utf8 %>%
  gt() %>%
  cols_width(Predictor ~ px(220)) %>%
  cols_align(align = "center", columns = -Predictor) %>%
  cols_align(align = "left",   columns = Predictor) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels(columns = everything())
  ) %>%
  tab_options(table.width = pct(100))
```

### Categorical moderators

```{r Low-mods-cat}
fit_cat_Low <- \(data, var, keep=NULL, ref=NULL)
  fit_cat(data, var, keep, ref, success_col = "Low_n", denom_col = "Sample_Size")

fits_cat_Low <- purrr::map_dfr(
  cat_vars, \(spec) do.call(fit_cat_Low, c(list(data = df_Low), spec))
)

# table
## set reference level
ref_prev_low <- fits_cat_Low %>%
  dplyr::filter(level == ref_level) %>%
  dplyr::select(moderator, ref_level, ref_prev = prevalence_pct)

# setup table
Low_cat_table <- fits_cat_Low %>%
  # drop ref–ref rows
  dplyr::filter(level != ref_level) %>%
  # join the correct ref prevalence for LOW
  dplyr::left_join(ref_prev_low, by = c("moderator", "ref_level")) %>%
  # pretty names for ref and comparison
  dplyr::left_join(lvl_map, by = c("moderator", "ref_level" = "orig")) %>%
  dplyr::rename(pretty_ref = pretty) %>%
  dplyr::left_join(lvl_map, by = c("moderator", "level" = "orig")) %>%
  dplyr::rename(pretty_cmp = pretty) %>%
  dplyr::mutate(
    Predictor                 = dplyr::recode(moderator, !!!mod_labels, .default = moderator),
    `Samples (k)`             = n,
    `Reference (Name)`        = dplyr::coalesce(pretty_ref, ref_level),
    `Reference (Prevalence)`  = sprintf("%.1f%%", ref_prev),
    `Comparison (Name)`       = dplyr::coalesce(pretty_cmp, level),
    `Comparison (Prevalence)` = sprintf("%.1f%%", prevalence_pct),
    !!delta_col               := round(diff_vs_ref_pp, 2),  # <-- key change
    `p-value`                 = paste0(fmt_p(p_value), ifelse(is.na(p_value), "", paste0(" ", sig(p_value))))
  ) %>%
  dplyr::select(
    Predictor, `Samples (k)`, `Reference (Name)`, `Reference (Prevalence)`,
    `Comparison (Name)`, `Comparison (Prevalence)`, dplyr::all_of(delta_col), `p-value`
  ) %>%
  dplyr::arrange(Predictor, `Comparison (Name)`)

# Render
Low_cat_table %>%
  gt() %>%
  cols_width(Predictor ~ px(110)) %>%
  cols_align(align = "left",   columns = Predictor) %>%
  cols_align(align = "center", columns = -Predictor) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = list(
      cells_column_labels(columns = everything())
    )
  ) %>%
  tab_options(
    data_row.padding = px(4),
    column_labels.padding = px(6),
    table.font.size = px(13)
  )
```

## 🌿 Decreasing Symptom Trajectory

```{r Decreasing-moderators-setup}
df_Decreasing <- df_moderation %>%
  filter(!is.na(Decreasing_percentage))

# Calculate Decreasing_n as (percentage / 100) * sample size
df_Decreasing$Decreasing_n <-
  round((df_Decreasing$Decreasing_percentage / 100) * df_Decreasing$Sample_Size)
```

### Descriptives

We provide additional descriptives based on the Decreasing trajectory variable, using the full dataset.

```{r Decreasing-descriptives}
# Total number of individuals classified as Decreasing (ignoring missingness in other variables)
total_Decreasing_n <- sum(df_Decreasing$Decreasing_n, na.rm = TRUE)

# Number of unique samples
unique_samples <- length(unique(df_Decreasing$Study))

# Display as a table
additional_info <- data.frame(
  Description = c("Total number of individuals in Decreasing trajectory", "Number of unique samples"),
  Value = format(c(total_Decreasing_n, unique_samples), big.mark = ",")
)

knitr::kable(additional_info, caption = "Additional Descriptives for Decreasing Trajectory Analysis")
```

### Continuous moderators

```{r Decreasing-mods-cont}
fit_cont_Decreasing <- \(data, var) fit_cont(data, var, success_col = "Decreasing_n", denom_col = "Sample_Size")

fits_cont_Decreasing <- map_dfr(cont_vars, ~fit_cont_Decreasing(df_Decreasing, .x)) %>%
  mutate(across(where(is.numeric), ~round(.x, 3)))

# table 
# build table
tbl <- fits_cont_Decreasing %>%
  mutate(
    Predictor = dplyr::recode(predictor, !!!mod_labels, .default = predictor),
    Predictor = factor(Predictor, levels = mod_levels),
    `Prevalence (0%)` = sprintf("%.1f%%", prevalence_at_0_pct),
    !!delta_col := marginal_delta_pp_per_unit,
    `P-value` = paste0(fmt_p(p_value), ifelse(is.na(p_value), "", paste0(" ", sig(p_value)))),
    Slope = slope
  ) %>%
  select(Predictor, Samples, `Prevalence (0%)`, Slope, dplyr::all_of(delta_col),`P-value`) %>%
  arrange(Predictor)

# ensure the table and its column names are UTF-8
tbl_utf8 <- tbl
names(tbl_utf8) <- enc2utf8(names(tbl_utf8))
tbl_utf8 <- dplyr::mutate(tbl_utf8, dplyr::across(where(is.character), enc2utf8))

# render
tbl_utf8 %>%
  gt() %>%
  cols_width(Predictor ~ px(220)) %>%
  cols_align(align = "center", columns = -Predictor) %>%
  cols_align(align = "left",   columns = Predictor) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels(columns = everything())
  ) %>%
  tab_options(table.width = pct(100))
```

### Categorical moderators

```{r Decreasing-mods-cat}
fit_cat_Decreasing <- \(data, var, keep=NULL, ref=NULL)
  fit_cat(data, var, keep, ref, success_col = "Decreasing_n", denom_col = "Sample_Size")

fits_cat_Decreasing <- purrr::map_dfr(
  cat_vars, \(spec) do.call(fit_cat_Decreasing, c(list(data = df_Decreasing), spec))
)

# table
## build table 
ref_prev_Decreasing <- fits_cat_Decreasing %>%
  dplyr::filter(level == ref_level) %>%
  dplyr::select(moderator, ref_level, ref_prev = prevalence_pct)

Decreasing_cat_table <- fits_cat_Decreasing %>%
  # drop ref–ref rows
  dplyr::filter(level != ref_level) %>%
  # join the correct ref prevalence for Decreasing
  dplyr::left_join(ref_prev_Decreasing, by = c("moderator", "ref_level")) %>%
  # pretty names for ref and comparison
  dplyr::left_join(lvl_map, by = c("moderator", "ref_level" = "orig")) %>%
  dplyr::rename(pretty_ref = pretty) %>%
  dplyr::left_join(lvl_map, by = c("moderator", "level" = "orig")) %>%
  dplyr::rename(pretty_cmp = pretty) %>%
  dplyr::mutate(
    Predictor                 = dplyr::recode(moderator, !!!mod_labels, .default = moderator),
    `Samples (k)`             = n,
    `Reference (Name)`        = dplyr::coalesce(pretty_ref, ref_level),
    `Reference (Prevalence)`  = sprintf("%.1f%%", ref_prev),
    `Comparison (Name)`       = dplyr::coalesce(pretty_cmp, level),
    `Comparison (Prevalence)` = sprintf("%.1f%%", prevalence_pct),
    !!delta_col               := round(diff_vs_ref_pp, 2),  # <-- key change
    `p-value`                 = paste0(fmt_p(p_value), ifelse(is.na(p_value), "", paste0(" ", sig(p_value))))
  ) %>%
  dplyr::select(
    Predictor, `Samples (k)`, `Reference (Name)`, `Reference (Prevalence)`,
    `Comparison (Name)`, `Comparison (Prevalence)`, dplyr::all_of(delta_col), `p-value`
  ) %>%
  dplyr::arrange(Predictor, `Comparison (Name)`)

## Render
Decreasing_cat_table %>%
  gt() %>%
  cols_width(Predictor ~ px(110)) %>%
  cols_align(align = "left",   columns = Predictor) %>%
  cols_align(align = "center", columns = -Predictor) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = list(
      cells_column_labels(columns = everything())
    )
  ) %>%
  tab_options(
    data_row.padding = px(4),
    column_labels.padding = px(6),
    table.font.size = px(13)
  )
```

## ⚠️ Increasing Symptom Trajectory

```{r Increasing-moderators-setup}
df_Increasing <- df_moderation %>%
  filter(!is.na(Increasing_percentage))

# Calculate Increasing_n as (percentage / 100) * sample size
df_Increasing$Increasing_n <-
  round((df_Increasing$Increasing_percentage / 100) * df_Increasing$Sample_Size)
```

### Descriptives

We provide additional descriptives based on the Increasing trajectory variable, using the full dataset.

```{r Increasing-descriptives}
# Total number of individuals classified as Increasing (ignoring missingness in other variables)
total_Increasing_n <- sum(df_Increasing$Increasing_n, na.rm = TRUE)

# Number of unique samples
unique_samples <- length(unique(df_Increasing$Study))

# Display as a table
additional_info <- data.frame(
  Description = c("Total number of individuals in Increasing trajectory", "Number of unique samples"),
  Value = format(c(total_Increasing_n, unique_samples), big.mark = ",")
)

knitr::kable(additional_info, caption = "Additional Descriptives for Increasing Trajectory Analysis")
```

### Continuous moderators

```{r Increasing-mods-cont}
fit_cont_Increasing <- \(data, var) fit_cont(data, var, success_col = "Increasing_n", denom_col = "Sample_Size")

fits_cont_Increasing <- map_dfr(cont_vars, ~fit_cont_Increasing(df_Increasing, .x)) %>%
  mutate(across(where(is.numeric), ~round(.x, 3)))

# build table
tbl <- fits_cont_Increasing %>%
  mutate(
    Predictor = dplyr::recode(predictor, !!!mod_labels, .default = predictor),
    Predictor = factor(Predictor, levels = mod_levels),
    `Prevalence (0%)` = sprintf("%.1f%%", prevalence_at_0_pct),
    !!delta_col := marginal_delta_pp_per_unit,
    `P-value` = paste0(fmt_p(p_value), ifelse(is.na(p_value), "", paste0(" ", sig(p_value)))),
    Slope = slope
  ) %>%
  select(Predictor, Samples, `Prevalence (0%)`, Slope, dplyr::all_of(delta_col),`P-value`) %>%
  arrange(Predictor)

# ensure the table and its column names are UTF-8
tbl_utf8 <- tbl
names(tbl_utf8) <- enc2utf8(names(tbl_utf8))
tbl_utf8 <- dplyr::mutate(tbl_utf8, dplyr::across(where(is.character), enc2utf8))

tbl_utf8 %>%
  gt() %>%
  cols_width(Predictor ~ px(220)) %>%
  cols_align(align = "center", columns = -Predictor) %>%
  cols_align(align = "left",   columns = Predictor) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels(columns = everything())
  ) %>%
  tab_options(table.width = pct(100))
```

### Categorical moderators

```{r Increasing-mods-cat}
fit_cat_Increasing <- \(data, var, keep=NULL, ref=NULL)
  fit_cat(data, var, keep, ref, success_col = "Increasing_n", denom_col = "Sample_Size")

fits_cat_Increasing <- purrr::map_dfr(
  cat_vars, \(spec) do.call(fit_cat_Increasing, c(list(data = df_Increasing), spec))
)

# build table
ref_prev_Increasing <- fits_cat_Increasing %>%
  dplyr::filter(level == ref_level) %>%
  dplyr::select(moderator, ref_level, ref_prev = prevalence_pct)

Increasing_cat_table <- fits_cat_Increasing %>%
  # drop ref–ref rows
  dplyr::filter(level != ref_level) %>%
  # join the correct ref prevalence for Increasing
  dplyr::left_join(ref_prev_Increasing, by = c("moderator", "ref_level")) %>%
  # pretty names for ref and comparison
  dplyr::left_join(lvl_map, by = c("moderator", "ref_level" = "orig")) %>%
  dplyr::rename(pretty_ref = pretty) %>%
  dplyr::left_join(lvl_map, by = c("moderator", "level" = "orig")) %>%
  dplyr::rename(pretty_cmp = pretty) %>%
  dplyr::mutate(
    Predictor                 = dplyr::recode(moderator, !!!mod_labels, .default = moderator),
    `Samples (k)`             = n,
    `Reference (Name)`        = dplyr::coalesce(pretty_ref, ref_level),
    `Reference (Prevalence)`  = sprintf("%.1f%%", ref_prev),
    `Comparison (Name)`       = dplyr::coalesce(pretty_cmp, level),
    `Comparison (Prevalence)` = sprintf("%.1f%%", prevalence_pct),
    !!delta_col               := round(diff_vs_ref_pp, 2),  # <-- key change
    `p-value`                 = paste0(fmt_p(p_value), ifelse(is.na(p_value), "", paste0(" ", sig(p_value))))
  ) %>%
  dplyr::select(
    Predictor, `Samples (k)`, `Reference (Name)`, `Reference (Prevalence)`,
    `Comparison (Name)`, `Comparison (Prevalence)`, dplyr::all_of(delta_col), `p-value`
  ) %>%
  dplyr::arrange(Predictor, `Comparison (Name)`)

# render
Increasing_cat_table %>%
  gt() %>%
  cols_width(Predictor ~ px(110)) %>%
  cols_align(align = "left",   columns = Predictor) %>%
  cols_align(align = "center", columns = -Predictor) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = list(
      cells_column_labels(columns = everything())
    )
  ) %>%
  tab_options(
    data_row.padding = px(4),
    column_labels.padding = px(6),
    table.font.size = px(13)
  )
```

## 🩸 High Symptom Trajectory

```{r High-moderators-setup}
df_High <- df_moderation

df_High <- df_High %>%
  filter(!is.na(High_percentage))

# Calculate High_n as (percentage / 100) * sample size
df_High$High_n <-
  round((df_High$High_percentage / 100) * df_High$Sample_Size)
```

### Descriptives

We provide additional descriptives based on the High trajectory variable, using the full dataset.

```{r High-descriptives}

# Total number of individuals classified as High (ignoring missingness in other variables)
total_High_n <- sum(df_High$High_n, na.rm = TRUE)

# Number of unique samples
unique_samples <- length(unique(df_High$Study))

# Display as a table
additional_info <- data.frame(
  Description = c("Total number of individuals in High trajectory", "Number of unique samples"),
  Value = format(c(total_High_n, unique_samples), big.mark = ",")
)

knitr::kable(additional_info, caption = "Additional Descriptives for High Trajectory Analysis")
```

### Continuous moderators

```{r High-mods-cont}
fit_cont_High <- \(data, var) fit_cont(data, var, success_col = "High_n", denom_col = "Sample_Size")

fits_cont_High <- map_dfr(cont_vars, ~fit_cont_High(df_High, .x)) %>%
  mutate(across(where(is.numeric), ~round(.x, 3)))

# build table
tbl <- fits_cont_High %>%
  mutate(
    Predictor = dplyr::recode(predictor, !!!mod_labels, .default = predictor),
    Predictor = factor(Predictor, levels = mod_levels),
    `Prevalence (0%)` = sprintf("%.1f%%", prevalence_at_0_pct),
    !!delta_col := marginal_delta_pp_per_unit,
    `P-value` = paste0(fmt_p(p_value), ifelse(is.na(p_value), "", paste0(" ", sig(p_value)))),
    Slope = slope
  ) %>%
  select(Predictor, Samples, `Prevalence (0%)`, Slope, dplyr::all_of(delta_col),`P-value`) %>%
  arrange(Predictor)

# ensure the table and its column names are UTF-8
tbl_utf8 <- tbl
names(tbl_utf8) <- enc2utf8(names(tbl_utf8))
tbl_utf8 <- dplyr::mutate(tbl_utf8, dplyr::across(where(is.character), enc2utf8))

# render
tbl_utf8 %>%
  gt() %>%
  cols_width(Predictor ~ px(220)) %>%
  cols_align(align = "center", columns = -Predictor) %>%
  cols_align(align = "left",   columns = Predictor) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels(columns = everything())
  ) %>%
  tab_options(table.width = pct(100))
```

### Categorical moderators

```{r High-mods-cat}
fit_cat_High <- \(data, var, keep=NULL, ref=NULL)
  fit_cat(data, var, keep, ref, success_col = "High_n", denom_col = "Sample_Size")

fits_cat_High <- purrr::map_dfr(
  cat_vars, \(spec) do.call(fit_cat_High, c(list(data = df_High), spec))
)

# build table
ref_prev_High <- fits_cat_High %>%
  dplyr::filter(level == ref_level) %>%
  dplyr::select(moderator, ref_level, ref_prev = prevalence_pct)

High_cat_table <- fits_cat_High %>%
  # drop ref–ref rows
  dplyr::filter(level != ref_level) %>%
  # join the correct ref prevalence for High
  dplyr::left_join(ref_prev_High, by = c("moderator", "ref_level")) %>%
  # pretty names for ref and comparison
  dplyr::left_join(lvl_map, by = c("moderator", "ref_level" = "orig")) %>%
  dplyr::rename(pretty_ref = pretty) %>%
  dplyr::left_join(lvl_map, by = c("moderator", "level" = "orig")) %>%
  dplyr::rename(pretty_cmp = pretty) %>%
  dplyr::mutate(
    Predictor                 = dplyr::recode(moderator, !!!mod_labels, .default = moderator),
    `Samples (k)`             = n,
    `Reference (Name)`        = dplyr::coalesce(pretty_ref, ref_level),
    `Reference (Prevalence)`  = sprintf("%.1f%%", ref_prev),
    `Comparison (Name)`       = dplyr::coalesce(pretty_cmp, level),
    `Comparison (Prevalence)` = sprintf("%.1f%%", prevalence_pct),
    !!delta_col               := round(diff_vs_ref_pp, 2),  # <-- key change
    `p-value`                 = paste0(fmt_p(p_value), ifelse(is.na(p_value), "", paste0(" ", sig(p_value))))
  ) %>%
  dplyr::select(
    Predictor, `Samples (k)`, `Reference (Name)`, `Reference (Prevalence)`,
    `Comparison (Name)`, `Comparison (Prevalence)`, dplyr::all_of(delta_col), `p-value`
  ) %>%
  dplyr::arrange(Predictor, `Comparison (Name)`)

# render
High_cat_table %>%
  gt() %>%
  cols_width(Predictor ~ px(110)) %>%
  cols_align(align = "left",   columns = Predictor) %>%
  cols_align(align = "center", columns = -Predictor) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = list(
      cells_column_labels(columns = everything())
    )
  ) %>%
  tab_options(
    data_row.padding = px(4),
    column_labels.padding = px(6),
    table.font.size = px(13)
  )
```

## 🌗 Moderate Symptom Trajectory

```{r Moderate-moderators-setup}
df_Moderate <- df_moderation

df_Moderate <- df_Moderate %>%
  filter(!is.na(Moderate_percentage))

# Calculate Moderate_n as (percentage / 100) * sample size
df_Moderate$Moderate_n <-
  round((df_Moderate$Moderate_percentage / 100) * df_Moderate$Sample_Size)
```

### Descriptives

We provide additional descriptives based on the Moderate trajectory variable, using the full dataset.

```{r Moderate-descriptives}
# Total number of individuals classified as Moderate (ignoring missingness in other variables)
total_Moderate_n <- sum(df_Moderate$Moderate_n, na.rm = TRUE)

# Number of unique samples
unique_samples <- length(unique(df_Moderate$Study))

# Display as a table
additional_info <- data.frame(
  Description = c("Total number of individuals in Moderate trajectory", "Number of unique samples"),
  Value = format(c(total_Moderate_n, unique_samples), big.mark = ",")
)

knitr::kable(additional_info, caption = "Additional Descriptives for Moderate Trajectory Analysis")
```

### Continuous moderators

```{r Moderate-mods-cont}
fit_cont_Moderate <- \(data, var) fit_cont(data, var, success_col = "Moderate_n", denom_col = "Sample_Size")

fits_cont_Moderate <- map_dfr(cont_vars, ~fit_cont_Moderate(df_Moderate, .x)) %>%
  mutate(across(where(is.numeric), ~round(.x, 3)))

# build table
tbl <- fits_cont_Moderate %>%
  mutate(
    Predictor = dplyr::recode(predictor, !!!mod_labels, .default = predictor),
    Predictor = factor(Predictor, levels = mod_levels),
    `Prevalence (0%)` = sprintf("%.1f%%", prevalence_at_0_pct),
    !!delta_col := marginal_delta_pp_per_unit,
    `P-value` = paste0(fmt_p(p_value), ifelse(is.na(p_value), "", paste0(" ", sig(p_value)))),
    Slope = slope
  ) %>%
  select(Predictor, Samples, `Prevalence (0%)`, Slope, dplyr::all_of(delta_col),`P-value`) %>%
  arrange(Predictor)

# ensure the table and its column names are UTF-8
tbl_utf8 <- tbl
names(tbl_utf8) <- enc2utf8(names(tbl_utf8))
tbl_utf8 <- dplyr::mutate(tbl_utf8, dplyr::across(where(is.character), enc2utf8))

tbl_utf8 %>%
  gt() %>%
  cols_width(Predictor ~ px(220)) %>%
  cols_align(align = "center", columns = -Predictor) %>%
  cols_align(align = "left",   columns = Predictor) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels(columns = everything())
  ) %>%
  tab_options(table.width = pct(100))
```

### Categorical moderators

```{r Moderate-mods-cat}
fit_cat_Moderate <- \(data, var, keep=NULL, ref=NULL)
  fit_cat(data, var, keep, ref, success_col = "Moderate_n", denom_col = "Sample_Size")

fits_cat_Moderate <- purrr::map_dfr(
  cat_vars, \(spec) do.call(fit_cat_Moderate, c(list(data = df_Moderate), spec))
)

# build table
ref_prev_Moderate <- fits_cat_Moderate %>%
  dplyr::filter(level == ref_level) %>%
  dplyr::select(moderator, ref_level, ref_prev = prevalence_pct)

Moderate_cat_table <- fits_cat_Moderate %>%
  # drop ref–ref rows
  dplyr::filter(level != ref_level) %>%
  # join the correct ref prevalence for Moderate
  dplyr::left_join(ref_prev_Moderate, by = c("moderator", "ref_level")) %>%
  # pretty names for ref and comparison
  dplyr::left_join(lvl_map, by = c("moderator", "ref_level" = "orig")) %>%
  dplyr::rename(pretty_ref = pretty) %>%
  dplyr::left_join(lvl_map, by = c("moderator", "level" = "orig")) %>%
  dplyr::rename(pretty_cmp = pretty) %>%
  dplyr::mutate(
    Predictor                 = dplyr::recode(moderator, !!!mod_labels, .default = moderator),
    `Samples (k)`             = n,
    `Reference (Name)`        = dplyr::coalesce(pretty_ref, ref_level),
    `Reference (Prevalence)`  = sprintf("%.1f%%", ref_prev),
    `Comparison (Name)`       = dplyr::coalesce(pretty_cmp, level),
    `Comparison (Prevalence)` = sprintf("%.1f%%", prevalence_pct),
    !!delta_col               := round(diff_vs_ref_pp, 2),  # <-- key change
    `p-value`                 = paste0(fmt_p(p_value), ifelse(is.na(p_value), "", paste0(" ", sig(p_value))))
  ) %>%
  dplyr::select(
    Predictor, `Samples (k)`, `Reference (Name)`, `Reference (Prevalence)`,
    `Comparison (Name)`, `Comparison (Prevalence)`, dplyr::all_of(delta_col), `p-value`
  ) %>%
  dplyr::arrange(Predictor, `Comparison (Name)`)

# render
Moderate_cat_table %>%
  gt() %>%
  cols_width(Predictor ~ px(110)) %>%
  cols_align(align = "left",   columns = Predictor) %>%
  cols_align(align = "center", columns = -Predictor) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = list(
      cells_column_labels(columns = everything())
    )
  ) %>%
  tab_options(
    data_row.padding = px(4),
    column_labels.padding = px(6),
    table.font.size = px(13)
  )
```
# Substantive Models
## Setup
```{r substantive-mods-setup-functions}
background_vars <- c(
  "Mean_age", "Developmental_age",
  "Percentage_women", "Percentage_minority", "Percentage_partner", "High_education",
  "Location", "Location_US"
)

trauma_vars <- c(
  "Discrete", "Health_First", "Trauma_type", "Military",
  "Occupational_trauma", "Trauma_exposure"
)

method_vars <- c(
  "Sample_Size_100", "Grolts", "Entropy", "Scale_moderator",
  "Diagnostic_DSM", "Trajectory_analysis",
  "TP_assessments", "N_trajectories",
  "Trauma_TP1", "TP1_TPX", "Trauma_TPX"
)

cat_specs <- list(
  Diagnostic_DSM      = list(keep = c("4","5"),                     ref = "4"),
  Occupational_trauma = list(keep = c("No","Yes"),                  ref = "No"),
  Developmental_age   = list(keep = c("Adult","Youth"),             ref = "Adult"),
  Location            = list(keep = NULL,                           ref = NULL),
  Location_US         = list(keep = NULL,                           ref = "Non-US"),
  Trajectory_analysis = list(keep = NULL,                           ref = NULL),
  Scale_moderator     = list(keep = c("Interview","Self"),          ref = "Interview"),
  Trauma_exposure     = list(keep = c("Inter","Non"),               ref = "Inter"),
  Trauma_type         = list(keep = c("Combat","Natural","Injury"), ref = "Combat"),
  Military            = list(keep = NULL,                           ref = "No"),
  Discrete            = list(keep = c("No","Yes"),                  ref = "No"),
  Health_First        = list(keep = c("Yes","No"),                  ref = "Yes")
)

is_categorical <- function(v) v %in% names(cat_specs)
.ctrl <- glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 2e5))
.pcol <- function(coef_mat) {
  hits <- intersect(colnames(coef_mat), c("Pr(>|z|)", "Pr(>|t|)", "Pr(>|Chisq|)"))
  if (length(hits)) hits[1] else NA_character_
}
# Factorize one predictor (apply keep/ref if categorical)
prep_predictor <- function(d, var) {
  var_sym <- rlang::sym(var)
  d <- d %>% dplyr::filter(!is.na(.data[[var]]))

  if (is_categorical(var)) {
    keep <- cat_specs[[var]]$keep
    ref  <- cat_specs[[var]]$ref

    if (!is.null(keep)) d <- d %>% dplyr::filter(.data[[var]] %in% keep)

    d <- d %>%
      mutate(
        !!var_sym := forcats::as_factor(.data[[var]])
      )

    if (!is.null(ref) && ref %in% levels(d[[var]])) {
      d[[var]] <- forcats::fct_relevel(d[[var]], ref)
    } else {
      d[[var]] <- forcats::fct_drop(d[[var]])
    }
  }

  d
}

# Categorical: level-wise prevalence and deltas vs ref
fit_cat <- function(data, var, success_col = "Low_n", denom_col = "Sample_Size") {
  d <- data %>% prep_predictor(var) %>% add_binom_cols(success_col, denom_col)
  if (!is_categorical(var) || nlevels(d[[var]]) < 2) return(tibble::tibble())

  fml <- stats::as.formula(paste0("cbind(Success, Failure) ~ ", var, " + (1 | Study)"))
  m <- lme4::glmer(fml, data = d, family = binomial, control = .ctrl)

  fe <- lme4::fixef(m)
  b0 <- unname(fe["(Intercept)"])
  lvls <- levels(d[[var]])

  # In treatment coding, reference level has no coefficient; others are named varLevel
  add <- sapply(lvls, function(L) { nm <- paste0(var, L); if (nm %in% names(fe)) fe[[nm]] else 0 })

  s <- summary(m)$coefficients
  pcol <- .pcol(s)
  pvals <- sapply(lvls, function(L) {
    nm <- paste0(var, L)
    if (!is.na(pcol) && nm %in% rownames(s)) unname(s[nm, pcol]) else NA_real_
  })

  p <- plogis(b0 + add)
  p_ref <- p[1]

  tibble::tibble(
    trajectory      = sub("_n$", "", success_col),
    moderator       = var,
    n               = stats::nobs(m),
    ref_level       = lvls[1],
    level           = lvls,
    prevalence_pct  = 100 * p,
    diff_vs_ref_pp  = 100 * (p - p_ref),
    p_value         = pvals
  )
}

# Run a set of variables on a trajectory dataset
run_group <- function(df_traj, vars, success_col = "Low_n", denom_col = "Sample_Size") {
  is_cat <- vapply(vars, is_categorical, logical(1))
  cont_vars <- vars[!is_cat]
  cat_vars  <- vars[is_cat]

  res_cont <- if (length(cont_vars)) purrr::map_dfr(cont_vars, ~fit_cont(df_traj, .x, success_col, denom_col)) else tibble::tibble()
  res_cat  <- if (length(cat_vars))  purrr::map_dfr(cat_vars,  ~fit_cat (df_traj, .x, success_col, denom_col)) else tibble::tibble()

  list(cont = res_cont, cat = res_cat)
}

# Unified table with spanner headers 
UNIFIED_COLS <- c(
  "Predictor", "k_shared",
  "Ref_Prevalence_Cont", "Delta_Marginal_Cont", "p_value_shared",
  "Ref_Name_Cat", "Ref_Prevalence_Cat", "Comp_Name_Cat", "Comp_Prevalence_Cat", "Delta_Marginal_Cat"
)

.empty_unified_tbl <- function() {
  tibble::tibble(
    Predictor            = character(),
    k_shared             = integer(),   # <- integer, not character
    Ref_Prevalence_Cont  = character(),
    Delta_Marginal_Cont  = character(),
    p_value_shared       = character(),
    Ref_Name_Cat         = character(),
    Ref_Prevalence_Cat   = character(),
    Comp_Name_Cat        = character(),
    Comp_Prevalence_Cat  = character(),
    Delta_Marginal_Cat   = character()
  )
}

.na_label <- "-"

make_group_table <- function(group_res, title, na_label = .na_label) {

  # --- A. Continuous ---
  cont_tbl <- if (!is.null(group_res$cont) && nrow(group_res$cont) > 0) {
    group_res$cont %>%
      mutate(
        Predictor           = dplyr::recode(predictor, !!!mod_labels, .default = predictor),
        k_shared            = as.integer(Samples),  # ensure integer
        Ref_Prevalence_Cont = sprintf("%.2f%%", prevalence_at_0_pct),
        Delta_Marginal_Cont = !!delta_col,
        p_value_shared      = paste0(fmt_p(p_value), ifelse(is.na(p_value), "", paste0(" ", sig(p_value)))),
        Ref_Name_Cat        = na_label,
        Ref_Prevalence_Cat  = na_label,
        Comp_Name_Cat       = na_label,
        Comp_Prevalence_Cat = na_label,
        Delta_Marginal_Cat  = na_label
      ) %>%
      select(all_of(UNIFIED_COLS))
  } else {
    .empty_unified_tbl()
  }
  
  # --- B. Categorical ---
  cat_tbl <- if (!is.null(group_res$cat) && nrow(group_res$cat) > 0) {
    ref_prev <- group_res$cat %>%
      filter(level == ref_level) %>%
      select(moderator, ref_level, ref_prev = prevalence_pct)
  
    group_res$cat %>%
      filter(level != ref_level) %>%
      left_join(ref_prev, by = c("moderator","ref_level")) %>%
      left_join(lvl_map, by = c("moderator","ref_level" = "orig")) %>%
      rename(pretty_ref = pretty) %>%
      left_join(lvl_map, by = c("moderator","level" = "orig")) %>%
      rename(pretty_cmp = pretty) %>%
      mutate(
        Predictor            = dplyr::recode(moderator, !!!mod_labels, .default = moderator),
        k_shared             = as.integer(n),  # ensure integer
        Ref_Prevalence_Cont  = na_label,
        Delta_Marginal_Cont  = na_label,
        Ref_Name_Cat         = coalesce(pretty_ref, ref_level),
        Ref_Prevalence_Cat   = sprintf("%.1f%%", ref_prev),
        Comp_Name_Cat        = coalesce(pretty_cmp, level),
        Comp_Prevalence_Cat  = sprintf("%.1f%%", prevalence_pct),
        Delta_Marginal_Cat   = sprintf("%.2f", diff_vs_ref_pp),
        p_value_shared       = paste0(fmt_p(p_value), ifelse(is.na(p_value), "", paste0(" ", sig(p_value))))
      ) %>%
      select(all_of(UNIFIED_COLS))
  } else {
    .empty_unified_tbl()
  }


  # ---- C. Bind + render ----
  out <- bind_rows(cont_tbl, cat_tbl)

  gt::gt(out) %>%
    gt::tab_header(title = enc2utf8(title)) %>%
    gt::cols_label(
      Predictor = gt::md("**Predictor**"),
      k_shared = gt::md("k"),
      p_value_shared = gt::md("p-value"),
      Ref_Prevalence_Cont = gt::md("Relative<br>prevalence at 0%"),
      Delta_Marginal_Cont = gt::md("Marginal Δ<br>(per 1%)"),
      Ref_Name_Cat = gt::md("Reference (Name)"),
      Ref_Prevalence_Cat = gt::md("Reference Prevalence"),
      Comp_Name_Cat = gt::md("Comparison (Name)"),
      Comp_Prevalence_Cat = gt::md("Comparison Prevalence"),
      Delta_Marginal_Cat = gt::md("Marginal Δ")
    ) %>%
    gt::tab_spanner(
      label = gt::md("**Continuous Moderators**"),
      columns = c(Ref_Prevalence_Cont, Delta_Marginal_Cont),
      id = "cont_group"
    ) %>%
    gt::tab_spanner(
      label = gt::md("**Categorical Moderators**"),
      columns = c(Ref_Name_Cat, Ref_Prevalence_Cat, Comp_Name_Cat, Comp_Prevalence_Cat, Delta_Marginal_Cat),
      id = "cat_group"
    ) %>%
    gt::cols_align("left",   columns = Predictor) %>%
    gt::cols_align("center", columns = -Predictor) %>%
    gt::cols_width(Predictor ~ gt::px(180), k_shared ~ gt::px(50), p_value_shared ~ gt::px(70)) %>%
    gt::tab_style(
      style = gt::cell_text(weight = "bold"),
      locations = gt::cells_column_labels(columns = gt::everything())
    ) %>%
    gt::tab_options(
      table.width = gt::pct(100),
      data_row.padding = gt::px(4),
      column_labels.padding = gt::px(6),
      table.font.size = gt::px(13),
      table.font.names = "Times New Roman"
    )
}
```
## 🚀 Low Symptom Trajectory

```{r Low-mods-fitting}
# Run the three groups for this trajectory
bg_res_Low <- run_group(df_Low, success_col = "Low_n", denom_col = "Sample_Size", vars = background_vars)
tr_res_Low <- run_group(df_Low, success_col = "Low_n", denom_col = "Sample_Size", vars = trauma_vars)
md_res_Low <- run_group(df_Low, success_col = "Low_n", denom_col = "Sample_Size", vars = method_vars)

all_vars <- c(background_vars, trauma_vars, method_vars)
all_Low_res <- run_group(df_Low, success_col = "Low_n", denom_col = "Sample_Size", vars = all_vars)
```

```{r Low-mods-tables}
make_group_table(bg_res_Low, "Low Symptom Trajectory: Socio-Demographic Moderators")
make_group_table(tr_res_Low, "Low Symptom Trajectory: Trauma-Related Moderators")
make_group_table(md_res_Low, "Low Symptom Trajectory: Methodological Moderators")
make_group_table(all_Low_res, "Low Symptom Trajectory: All Moderators")
```
## Increasing Symptom Trajectory

```{r Increasing-mods-fitting}
# Run the three groups for this trajectory
bg_res_Increasing <- run_group(df_Increasing, success_col = "Increasing_n", denom_col = "Sample_Size", vars = background_vars)
tr_res_Increasing <- run_group(df_Increasing, success_col = "Increasing_n", denom_col = "Sample_Size", vars = trauma_vars)
md_res_Increasing <- run_group(df_Increasing, success_col = "Increasing_n", denom_col = "Sample_Size", vars = method_vars)

all_vars <- c(background_vars, trauma_vars, method_vars)
all_Increasing_res <- run_group(df_Increasing, success_col = "Increasing_n", denom_col = "Sample_Size", vars = all_vars)
```

```{r Increasing-mods-tables}
make_group_table(bg_res_Increasing, "Increasing Symptom Trajectory: Socio-Demographic Moderators")
make_group_table(tr_res_Increasing, "Increasing Symptom Trajectory: Trauma-Related Moderators")
make_group_table(md_res_Increasing, "Increasing Symptom Trajectory: Methodological Moderators")
make_group_table(all_Increasing_res, "Increasing Symptom Trajectory: All Moderators")
```
## 🚀 Decreasing Symptom Trajectory

```{r Decreasing-mods-fitting}
# Run the three groups for this trajectory
bg_res_Decreasing <- run_group(df_Decreasing, success_col = "Decreasing_n", denom_col = "Sample_Size", vars = background_vars)
tr_res_Decreasing <- run_group(df_Decreasing, success_col = "Decreasing_n", denom_col = "Sample_Size", vars = trauma_vars)
md_res_Decreasing <- run_group(df_Decreasing, success_col = "Decreasing_n", denom_col = "Sample_Size", vars = method_vars)

all_vars <- c(background_vars, trauma_vars, method_vars)
all_Decreasing_res <- run_group(df_Decreasing, success_col = "Decreasing_n", denom_col = "Sample_Size", vars = all_vars)
```

```{r Decreasing-mods-tables}
make_group_table(bg_res_Decreasing, "Decreasing Symptom Trajectory: Socio-Demographic Moderators")
make_group_table(tr_res_Decreasing, "Decreasing Symptom Trajectory: Trauma-Related Moderators")
make_group_table(md_res_Decreasing, "Decreasing Symptom Trajectory: Methodological Moderators")
make_group_table(all_Decreasing_res, "Decreasing Symptom Trajectory: All Moderators")
```
## 🚀 High Symptom Trajectory

```{r High-mods-fitting}
# Run the three groups for this trajectory
bg_res_High <- run_group(df_High, success_col = "High_n", denom_col = "Sample_Size", vars = background_vars)
tr_res_High <- run_group(df_High, success_col = "High_n", denom_col = "Sample_Size", vars = trauma_vars)
md_res_High <- run_group(df_High, success_col = "High_n", denom_col = "Sample_Size", vars = method_vars)

all_vars <- c(background_vars, trauma_vars, method_vars)
all_High_res <- run_group(df_High, success_col = "High_n", denom_col = "Sample_Size", vars = all_vars)
```

```{r High-mods-tables}
make_group_table(bg_res_High, "High Symptom Trajectory: Socio-Demographic Moderators")
make_group_table(tr_res_High, "High Symptom Trajectory: Trauma-Related Moderators")
make_group_table(md_res_High, "High Symptom Trajectory: Methodological Moderators")
make_group_table(all_High_res, "High Symptom Trajectory: All Moderators")
```

## 🚀 Moderate Symptom Trajectory

```{r Moderate-mods-fitting}
# Run the three groups for this trajectory
bg_res_Moderate <- run_group(df_Moderate, success_col = "Moderate_n", denom_col = "Sample_Size", vars = background_vars)
tr_res_Moderate <- run_group(df_Moderate, success_col = "Moderate_n", denom_col = "Sample_Size", vars = trauma_vars)
md_res_Moderate <- run_group(df_Moderate, success_col = "Moderate_n", denom_col = "Sample_Size", vars = method_vars)

all_vars <- c(background_vars, trauma_vars, method_vars)
all_Moderate_res <- run_group(df_Moderate, success_col = "Moderate_n", denom_col = "Sample_Size", vars = all_vars)
```

```{r Moderate-mods-tables}
make_group_table(bg_res_Moderate, "Moderate Symptom Trajectory: Socio-Demographic Moderators")
make_group_table(tr_res_Moderate, "Moderate Symptom Trajectory: Trauma-Related Moderators")
make_group_table(md_res_Moderate, "Moderate Symptom Trajectory: Methodological Moderators")
make_group_table(all_Moderate_res, "Moderate Symptom Trajectory: All Moderators")
```

# Tables for Paper
## Continuous Moderators Summary Table

```{r cont-mods-summary-table}
# enforce trajectory order
traj_order <- c("Low","Decreasing","Increasing","High","Moderate")

#define trajectory fits
fits_by_traj <- list(
  Low        = fits_cont_Low,
  Decreasing = fits_cont_Decreasing,
  Increasing = fits_cont_Increasing,
  High       = fits_cont_High,
  Moderate   = fits_cont_Moderate
)

# build combined table
tbl_all <- bind_rows(fits_by_traj, .id = "Trajectory") %>%
  mutate(
    Trajectory = factor(Trajectory, levels = traj_order),
    Predictor = dplyr::recode(predictor, !!!mod_labels, .default = predictor),
    Predictor = factor(Predictor, levels = mod_levels),
    `Prevalence (0%)` = sprintf("%.1f%%", prevalence_at_0_pct),
    !!delta_col := marginal_delta_pp_per_unit,
    `P-value` = paste0(fmt_p(p_value), ifelse(is.na(p_value), "", paste0(" ", sig(p_value)))),
    Slope = slope
  ) %>%
  select(Trajectory, Predictor, Samples, `Prevalence (0%)`, Slope, dplyr::all_of(delta_col), `P-value`) %>%
  arrange(Trajectory, Predictor)

# ensure UTF-8
tbl_all_utf8 <- tbl_all
names(tbl_all_utf8) <- enc2utf8(names(tbl_all_utf8))
tbl_all_utf8 <- mutate(tbl_all_utf8, across(where(is.character), enc2utf8))

# render one big table, grouped by Trajectory
tbl_all_utf8 %>%
  gt(groupname_col = "Trajectory") %>%
  cols_width(Predictor ~ px(220)) %>%
  cols_align(align = "center", columns = -Predictor) %>%
  cols_align(align = "left",   columns = Predictor) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = list(
      cells_column_labels(columns = everything()),    # bold headers
      cells_row_groups(groups = everything())         # bold group labels
    )
  ) %>%
  tab_options(table.width = pct(100)) %>%
  opt_table_font(font = "Times New Roman") 
```

## Categorical Moderators Summary Table

```{r cat-mods-summary-table}
# enforce trajectory order
traj_order <- c("Low","Decreasing","Increasing","High","Moderate")

# find and combine all 'fits_cat_*' data frames
fit_names <- ls(pattern = "^fits_cat_")

if (length(fit_names) == 0) {
  knitr::kable(data.frame(Note = "No categorical moderator results found."))
} else {
  all_fits_cat <- mget(fit_names) %>%
    list_rbind(names_to = "traj") %>%
    mutate(traj = str_remove(traj, "fits_cat_"),
         traj = factor(traj, levels = traj_order))

  # Prepare the final long table data for gt
  long_table_data <- all_fits_cat %>%
    # Add reference prevalence to each row for comparison
    left_join(
      y  = filter(., level == ref_level) %>% select(traj, moderator, ref_prev = prevalence_pct),
      by = c("traj", "moderator")
    ) %>%
    filter(level != ref_level) %>%
    # Create and format the final columns
    mutate(
      Predictor               = recode(moderator, !!!mod_labels, .default = moderator),
      `Reference (Name)`      = coalesce(lvl_map$pretty[match(ref_level, lvl_map$orig)], ref_level),
      `Comparison (Name)`     = coalesce(lvl_map$pretty[match(level, lvl_map$orig)], level),
      `Samples (k)`           = n,
      `Reference Prevalence`  = sprintf("%.1f%%", ref_prev),
      `Comparison Prevalence` = sprintf("%.1f%%", prevalence_pct),
      !!delta_col      := round(diff_vs_ref_pp, 2),
      `p-value`               = paste0(fmt_p(p_value), " ", sig(p_value))
    ) %>%
    # Select and order the final columns
    select(
      traj, # This column is kept for grouping
      Predictor,
      `Samples (k)`,
      `Reference (Name)`,
      `Comparison (Name)`,
      `Reference Prevalence`,
      `Comparison Prevalence`,
      !!delta_col,
      `p-value`
    ) %>%
    arrange(traj, Predictor, `Comparison (Name)`)

  # Build the final table, grouped by trajectory
  long_table_data %>%
    gt(groupname_col = "traj") %>%
    # Apply styling
    cols_width(Predictor ~ px(220)) %>%
    cols_align(align = "center", columns = where(is.numeric) | where(is.character)) %>%
    cols_align(align = "left", columns = c(Predictor, `Reference (Name)`, `Comparison (Name)`)) %>%
    tab_style(
      style = cell_text(weight = "bold"),
      locations = list(
      cells_column_labels(columns = everything()),    # bold headers
      cells_row_groups(groups = everything())         # bold group labels
    )
     ) %>%
  tab_options(table.width = pct(100)) %>%
  opt_table_font(font = "Times New Roman") 
}
```
---






